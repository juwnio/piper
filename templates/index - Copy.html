<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Remote Mouse</title>
    <style>
        :root {
            --dot-size: 4px;
            --dot-spacing: 20px;
            --touchpad-color: #000000;
            --dot-color: rgba(255, 255, 255, 0.15);
            --dot-active-color: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #000000, #1a1a1a);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #touchpad {
            width: 80vw;
            height: 50vh;
            background-color: var(--touchpad-color);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        #touchpad.expanded {
            position: fixed;
            top: 16px;
            left: 16px;
            right: 16px;
            bottom: 16px;
            width: auto;
            height: auto;
            border-radius: 24px;
        }

        .dot-grid {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, var(--dot-spacing));
            grid-template-rows: repeat(auto-fill, var(--dot-spacing));
            justify-content: center;
            align-content: center;
            padding: var(--dot-spacing);
        }

        .dot {
            width: var(--dot-size);
            height: var(--dot-size);
            background-color: var(--dot-color);
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .dot.active {
            background-color: var(--dot-active-color);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 80vw;
            margin-top: 1rem;
        }

        #keyboardInputContainer {
            flex-grow: 1;
            margin: 0 1rem;
        }

        #keyboardInputContainer.hidden {
            display: none;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: white;
        }

        .expand-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 2;
        }

        .right-click-btn {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            z-index: 2;
        }

        #killConfirmation {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #000000, #1a1a1a);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 100;
        }

        #killConfirmation.visible {
            display: flex;
        }

        #killConfirmation h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        #killConfirmation p {
            font-size: 1.2rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Piper</div>
        <button id="killSwitch">Kill Server</button>
    </header>

    <main>
        <div id="touchpad">
            <div class="dot-grid"></div>
            <button class="expand-btn" id="expandBtn">&lt;&gt;</button>
            <button class="right-click-btn" id="rightClickBtn">right.click</button>
        </div>
        <div class="controls">
            <button id="normalRightClickBtn">right.click</button>
            <div id="keyboardInputContainer" class="hidden">
                <input type="text" id="textInput" placeholder="Type here">
            </div>
            <button id="keyboardToggleBtn">⌨️</button>
        </div>
    </main>

    <div id="killConfirmation">
        <h1>Server Killed Successfully</h1>
        <p>The remote mouse server has been terminated.</p>
        <p>You can now close this window.</p>
    </div>

    <script>
        const touchpad = document.getElementById('touchpad');
        const dotGrid = document.querySelector('.dot-grid');
        const expandBtn = document.getElementById('expandBtn');
        const rightClickBtn = document.getElementById('rightClickBtn');
        const normalRightClickBtn = document.getElementById('normalRightClickBtn');
        const keyboardToggleBtn = document.getElementById('keyboardToggleBtn');
        const keyboardInputContainer = document.getElementById('keyboardInputContainer');
        const textInput = document.getElementById('textInput');
        const killSwitch = document.getElementById('killSwitch');
        const killConfirmation = document.getElementById('killConfirmation');

        let lastX = 0;
        let lastY = 0;
        let isTouch = false;
        let serverURL = '';
        let lastTap = null;
        let isExpanded = false;

        // Create dot grid
        function createDotGrid() {
            dotGrid.innerHTML = '';
            const cols = Math.floor(dotGrid.offsetWidth / 20);
            const rows = Math.floor(dotGrid.offsetHeight / 20);
            
            for (let i = 0; i < rows * cols; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dotGrid.appendChild(dot);
            }
        }

        function updateDots(x, y) {
            const dots = document.querySelectorAll('.dot');
            const rect = dotGrid.getBoundingClientRect();
            const radius = 40;

            dots.forEach(dot => {
                const dotRect = dot.getBoundingClientRect();
                const dotX = dotRect.left + dotRect.width / 2;
                const dotY = dotRect.top + dotRect.height / 2;
                const distance = Math.sqrt(Math.pow(x - dotX, 2) + Math.pow(y - dotY, 2));
                
                dot.classList.toggle('active', distance < radius);
            });
        }

        function toggleExpanded() {
            isExpanded = !isExpanded;
            touchpad.classList.toggle('expanded', isExpanded);
            rightClickBtn.style.display = isExpanded ? 'block' : 'none';
            normalRightClickBtn.style.display = isExpanded ? 'none' : 'block';
            expandBtn.textContent = isExpanded ? '><' : '<>';
            document.querySelector('header').style.display = isExpanded ? 'none' : 'flex';
            document.querySelector('.controls').style.display = isExpanded ? 'none' : 'flex';
            createDotGrid();
        }

        async function getServerURL() {
            try {
                const response = await fetch('/qr');
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64data = reader.result;
                    const urlRegex = /http:\/\/[^"]+/;
                    const match = base64data.match(urlRegex);
                    serverURL = match ? match[0] : `http://${window.location.hostname}:5000`;
                };
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error('Error fetching QR code:', error);
                serverURL = `http://${window.location.hostname}:5000`;
            }
        }

        async function sendRequest(endpoint, data = {}) {
            const url = serverURL ? `${serverURL}/${endpoint}` : `/${endpoint}`;
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        touchpad.addEventListener('touchstart', (e) => {
            isTouch = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            updateDots(lastX, lastY);

            const now = Date.now();
            if (lastTap && (now - lastTap) < 300) {
                sendRequest('click', { button: 'left' });
                lastTap = null;
            } else {
                lastTap = now;
            }
        });

        touchpad.addEventListener('touchmove', (e) => {
            if (!isTouch) return;
            e.preventDefault();

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const deltaX = currentX - lastX;
            const deltaY = currentY - lastY;

            sendRequest('move', { x: deltaX, y: deltaY });
            updateDots(currentX, currentY);

            lastX = currentX;
            lastY = currentY;
        });

        touchpad.addEventListener('touchend', () => {
            isTouch = false;
            const dots = document.querySelectorAll('.dot');
            dots.forEach(dot => dot.classList.remove('active'));
        });

        function handleRightClick() {
            sendRequest('click', { button: 'right' });
        }

        function toggleKeyboard(show) {
            keyboardInputContainer.classList.toggle('hidden', !show);
            keyboardToggleBtn.style.display = show ? 'none' : 'block';
            if (show) {
                textInput.focus();
            } else {
                textInput.blur();
                textInput.value = '';
            }
        }

        textInput.addEventListener('input', (e) => {
            if (e.data) sendRequest('type', { text: e.data });
        });

        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                e.preventDefault();
                sendRequest('type', { text: '{BACKSPACE}' });
                textInput.value = textInput.value.slice(0, -1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                sendRequest('type', { text: '{ENTER}' });
                toggleKeyboard(false);
            }
        });

        killSwitch.addEventListener('click', async () => {
            await sendRequest('kill');
            killConfirmation.classList.add('visible');
        });

        expandBtn.addEventListener('click', toggleExpanded);
        rightClickBtn.addEventListener('click', handleRightClick);
        normalRightClickBtn.addEventListener('click', handleRightClick);
        keyboardToggleBtn.addEventListener('click', () => toggleKeyboard(true));
        textInput.addEventListener('blur', () => toggleKeyboard(false));

        // Initialize
        getServerURL();
        createDotGrid();
        window.addEventListener('resize', createDotGrid);
    </script>
</body>
</html>