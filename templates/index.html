<!DOCTYPE html>
<html>

<head>
    <title>Piper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #touchpad {
            width: 300px;
            height: 200px;
            background-color: #fff;
            /* border: 1px solid #ccc;  Removed boarder */
            margin-bottom: 20px;
            touch-action: none;
            /* Disable default touch actions */
        }

        #buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #keyboard {
            margin-top: 20px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>Remote Mouse</h1>
    <div id="touchpad"></div>
    <div id="buttons">
        <button onclick="clickButton('right')">Right Click</button>
    </div>
    <div id="keyboard">
        <input type="text" id="textInput" placeholder="Type here">
        <button onclick="sendSpecialKey('{BACKSPACE}')">Backspace</button>
        <button onclick="sendSpecialKey('{ENTER}')">Enter</button>
    </div>
    <button onclick="killServer()">Kill Server</button>
    <script>
        const touchpad = document.getElementById('touchpad');
        let lastX = 0;
        let lastY = 0;
        let isTouch = false;
        let velocityX = 0;
        let velocityY = 0;
        let lastUpdate = Date.now();
        let serverURL = '';

        let lastTap = null;

        // Function to extract server URL from QR code image
        function getServerURL() {
            fetch('/qr')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result;
                        // Regular expression to extract URL from base64 data
                        const urlRegex = /http:\/\/[^"]+/;
                        const match = base64data.match(urlRegex);
                        if (match) {
                            serverURL = match[0];
                        } else {
                            serverURL = `http://${window.location.hostname}:5000`;
                        }
                        console.log('Server URL:', serverURL);
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error('Error fetching QR code:', error);
                    serverURL = `http://${window.location.hostname}:5000`;
                });
        }

        // Call getServerURL when the page loads
        getServerURL();

        touchpad.addEventListener('touchstart', (e) => {
            isTouch = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            lastUpdate = Date.now();

            // Double-click implementation
            const now = new Date().getTime();
            const DOUBLE_CLICK_THRESHOLD = 300; // Adjust this value as needed

            if (lastTap && (now - lastTap) < DOUBLE_CLICK_THRESHOLD) {
                // Double-click detected, perform left click
                clickButton('left');
                lastTap = null;
            } else {
                lastTap = now;
            }
        });

        touchpad.addEventListener('touchmove', (e) => {
            if (!isTouch) return;

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;

            // Calculate velocity
            const now = Date.now();
            const timeDelta = now - lastUpdate;
            velocityX = (currentX - lastX) / timeDelta;
            velocityY = (currentY - lastY) / timeDelta;

            // Apply prediction
            const predictedX = currentX + velocityX * timeDelta;
            const predictedY = currentY + velocityY * timeDelta;

            moveMouse(currentX - lastX, currentY - lastY);

            lastX = currentX;
            lastY = currentY;
            lastUpdate = now;
        });

        touchpad.addEventListener('touchend', () => {
            isTouch = false;
            velocityX = 0;
            velocityY = 0;
        });

        function moveMouse(x, y) {
            // Use serverURL if available, otherwise use relative path
            const url = serverURL ? `${serverURL}/move` : '/move';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    x: x,
                    y: y
                })
            });
        }

        function clickButton(button) {
            // Use serverURL if available, otherwise use relative path
            const url = serverURL ? `${serverURL}/click` : '/click';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    button: button
                })
            });
        }

        // Function to send text as it's being typed
        document.getElementById('textInput').addEventListener('input', function (e) {
            const text = e.data; // Get the last character typed
            if (text) {
                // Use serverURL if available, otherwise use relative path
                const url = serverURL ? `${serverURL}/type` : '/type';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text
                    })
                });
            }
        });

        function sendSpecialKey(key) {
            // Use serverURL if available, otherwise use relative path
            const url = serverURL ? `${serverURL}/type` : '/type';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: key
                })
            });
        }

        function killServer() {
            // Use serverURL if available, otherwise use relative path
            const url = serverURL ? `${serverURL}/kill` : '/kill';
            fetch(url, {
                method: 'POST'
            });
        }
    </script>
</body>

</html>
